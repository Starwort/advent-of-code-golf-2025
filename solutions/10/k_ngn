(L;B;J):+{(2!*p;~^-1_s?\:!#*p;*|s:`I$","\'1_p:1_'-1_'" "\x)}'0:0

+/L{&/+/2\&x~/:(~=/~y@&)'+!(#y)#2}'B
+/{
 (A;b):+(0,#x)_/:*(+x,,y;0){(A;k):x
   A@:>~~A
   $[~0^A[k;y];:x;j:(&~~A[;y])^k]
   A[j]:(A[j]*A[k;y])-A[k]*/:A[j;y]
   (A;k+1)}/!#x
 b:*'b
 vs:?,/v:(1_&:)'~~A
 c:b-+/'(A@'v)*(t:+{:[~#y; ,!0; ,/o\:[x-/:i*\:l;-1_y],''i:!1+&/x@&l:*|y]}[y;x@vs])@vs?v
 d:A@'*'&'~~A
 q:t,(d&-d)!'c*0 0'd
 &/+/q@\:&(~|/(d|-d)!'c)&~|/q<0}'[B;J]