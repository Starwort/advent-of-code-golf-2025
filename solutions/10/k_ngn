(L;B;J):+{(2!*p;~^-1_s?\:!#*p;*|s:`I$","\'1_p:1_'-1_'" "\x)}'0:0

+/L{&/+/2\&x~/:(~=/~y@&)'+!(#y)#2}'B
+/{k::0
 (A;b):+(0,#x)_/:(+x,,y){
   x@:>~~x
   $[~0^x[k;y];:x;j:(&~~x[;y])^k]
   x[j]:(x[j]*x[k;y])-x[k]*/:x[j;y]
   k+:1;x}/!#x
 b:*'b
 V:?,/v:(1_&:)'~~A
 c:b-+/'(A@'v)*(t:+{:[~#y; ,!0; ,/o\:[x-/:i*\:l;-1_y],''i:!1+&/x@&l:*|y]}[y;x@V])@V?v
 &/+/q@\:&~(|/w!'c)|0>&/q:t,(-w:d|-d)!'c*0 0'd:A@'*'&'~~A}'[B;J]